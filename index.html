<!DOCTYPE html>  
<html lang="ja">  
<head>  
<meta charset="UTF-8">  
<title>ドリンク管理システム</title>  
<style>  
body { margin:0; font-family:sans-serif; background:#111; color:white; }  
.app { padding:15px; max-width:1200px; margin:auto; }  
.card { background:#1e1e1e; padding:12px; margin-bottom:15px; border-radius:10px; }  
input { padding:8px; border-radius:6px; border:none; }  
button { padding:6px 12px; margin:5px 3px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; }  
.deleteBtn { background:#555; color:white; font-size:12px; padding:3px 8px; }  
.plus { background:#2196f3; color:white; }  
.minus { background:#d50000; color:white; }  
table { width:100%; border-collapse:collapse; text-align:center; }  
th,td { border:1px solid #333; padding:6px; }  
th { background:#222; }  
.cellControls { display:flex; justify-content:center; align-items:center; gap:4px; }  
.totalCol { background:#1e1e1e; font-weight:bold; }  
#logArea { max-height:250px; overflow-y:auto; font-size:14px; margin-top:8px; }  
.logItem { padding:4px 0; border-bottom:1px solid #333; }  
.logPlus { color:#2196f3; }  
.logMinus { color:#ff5252; }  
</style>  
</head>  
<body>  
  
<div class="app">  
  
<div class="card">  
<h3>営業日</h3>  
<input type="date" id="saleDate">  
</div>  
  
<h2>ドリンク管理システム</h2>  
  
<div class="card">  
<h3>① 女の子登録</h3>  
<input id="girlName" placeholder="名前を入力">  
<button onclick="addGirl()">追加</button>  
<div id="girlList"></div>  
</div>  
  
<div class="card">  
<h3>② 今日の出勤選択</h3>  
<button onclick="confirmAttendance()">出勤確定</button>  
</div>  
  
<div id="drinkArea"></div>  
  
<div class="card">  
<h3>操作ログ</h3>  
<button onclick="clearLogs()" style="background:#aa0000;color:white;">  
ログ削除  
</button>  
<div id="logArea"></div>  
</div>  
  
<div class="card">  
<h3>③ データ操作</h3>  
<button onclick="exportCSV()">CSV書き出し</button>  
<button onclick="resetToday()">今日の数値をリセット</button>  
</div>  
  
</div>  
  
<script>  
let girls = JSON.parse(localStorage.getItem("girls")) || [];  
let todayGirls = [];  
let actionLogs = [];  
  
const drinksList = ["S","M","L","shotA","shotB","mega","場内"];  
  
// =================  
// キー管理  
// =================  
function getDate(){ return document.getElementById("saleDate").value; }  
function getDataKey(){ return "data_" + getDate(); }  
function getLogKey(){ return "log_" + getDate(); }  
  
// =================  
// 初期化  
// =================  
document.addEventListener("DOMContentLoaded", () => {  
  const today = new Date().toISOString().split("T")[0];  
  document.getElementById("saleDate").value = today;  
  renderGirlList();  
  loadSession();  
  loadLogs();  
});  
  
document.getElementById("saleDate").addEventListener("change", () => {  
  loadSession();  
  loadLogs();  
});  
  
// =================  
// 保存・読込  
// =================  
function saveSession(){  
  localStorage.setItem(getDataKey(), JSON.stringify(todayGirls));  
}  
  
function loadSession(){  
  todayGirls = JSON.parse(localStorage.getItem(getDataKey())) || [];  
  renderTable();  
}  
  
function saveLogs(){  
  localStorage.setItem(getLogKey(), JSON.stringify(actionLogs));  
}  
  
function loadLogs(){  
  actionLogs = JSON.parse(localStorage.getItem(getLogKey())) || [];  
  renderLogs();  
}  
  
// =================  
// 女の子管理（永久保持）  
// =================  
function saveGirls(){  
  localStorage.setItem("girls", JSON.stringify(girls));  
}  
  
function addGirl(){  
  const name = document.getElementById("girlName").value.trim();  
  if(!name) return;  
  girls.push(name);  
  saveGirls();  
  renderGirlList();  
  document.getElementById("girlName").value="";  
}  
  
function deleteGirl(index){  
  if(!confirm("削除しますか？")) return;  
  girls.splice(index,1);  
  saveGirls();  
  renderGirlList();  
}  
  
function renderGirlList(){  
  const list = document.getElementById("girlList");  
  list.innerHTML="";  
  girls.forEach((g,i)=>{  
    list.innerHTML+=`  
    <div>  
      <input type="checkbox" value="${g}"> ${g}  
      <button class="deleteBtn" onclick="deleteGirl(${i})">削除</button>  
    </div>`;  
  });  
}  
  
// =================  
// 出勤確定  
// =================  
function confirmAttendance(){  
  const checked = document.querySelectorAll("#girlList input:checked");  
  todayGirls=[];  
  checked.forEach(cb=>{  
    let obj={};  
    drinksList.forEach(d=>obj[d]=0);  
    todayGirls.push({name:cb.value, drinks:obj});  
  });  
  saveSession();  
  renderTable();  
}  
  
// =================  
// 表描画  
// =================  
function renderTable(){  
  if(!todayGirls.length){  
    document.getElementById("drinkArea").innerHTML="";  
    return;  
  }  
  
  document.getElementById("drinkArea").innerHTML=`  
  <div class="card">  
  <table>  
  <thead>  
  <tr>  
  <th>名前</th>  
  ${drinksList.map(d=>`<th>${d}</th>`).join("")}  
  <th>合計</th>  
  </tr>  
  </thead>  
  <tbody>  
  ${todayGirls.map((girl,i)=>`  
    <tr>  
      <td>${girl.name}</td>  
      ${drinksList.map(type=>`  
        <td>  
          <div class="cellControls">  
            <button class="minus"  
              onclick="changeDrink(${i},'${type}',-1)">−</button>  
            <span>${girl.drinks[type]}</span>  
            <button class="plus"  
              onclick="changeDrink(${i},'${type}',1)">＋</button>  
          </div>  
        </td>`).join("")}  
      <td class="totalCol">${getTotal(girl)}</td>  
    </tr>`).join("")}  
  </tbody>  
  </table>  
  </div>`;  
}  
  
function changeDrink(i,type,amount){  
  const before = todayGirls[i].drinks[type];  
  const after = before + amount;  
  
  if(after < 0) return;  
  if(before === after) return;  
  
  todayGirls[i].drinks[type] = after;  
  
  addLog(todayGirls[i].name, type, amount);  
  saveSession();  
  renderTable();  
  renderLogs();  
}  
  
function getTotal(girl){  
  return Object.values(girl.drinks).reduce((a,b)=>a+b,0);  
}  
  
// =================  
// ログ  
// =================  
function addLog(name,type,amount){  
  const now = new Date();  
  const month = now.getMonth()+1;  
  const day = now.getDate();  
  const hours = now.getHours().toString().padStart(2,"0");  
  const minutes = now.getMinutes().toString().padStart(2,"0");  
  const seconds = now.getSeconds().toString().padStart(2,"0");  
  
  const timestamp = `${month}/${day} ${hours}:${minutes}:${seconds}`;  
  const sign = amount>0?"+":"-";  
  
  actionLogs.unshift({  
    text:`${timestamp}  ${name}  ${type}  ${sign}1`,  
    type: amount>0 ? "plus" : "minus"  
  });  
  
  saveLogs();  
}  
  
function renderLogs(){  
  const area=document.getElementById("logArea");  
  area.innerHTML=actionLogs.map(log=>  
    `<div class="logItem ${log.type==="plus"?"logPlus":"logMinus"}">  
      ${log.text}  
    </div>`  
  ).join("");  
}  
  
function clearLogs(){  
  if(!confirm("この営業日のログを削除しますか？")) return;  
  actionLogs=[];  
  localStorage.removeItem(getLogKey());  
  renderLogs();  
}  
  
// =================  
// CSV（列合計付き）  
// =================  
function exportCSV(){  
  if(!todayGirls.length){  
    alert("データがありません");  
    return;  
  }  
  
  const date=getDate();  
  if(!date){  
    alert("営業日を入力してください");  
    return;  
  }  
  
  let csv="名前,"+drinksList.join(",")+"\n";  
  
  todayGirls.forEach(girl=>{  
    csv += [girl.name,...drinksList.map(d=>girl.drinks[d])].join(",")+"\n";  
  });  
  
  // 列合計計算  
  let totals={};  
  drinksList.forEach(d=>totals[d]=0);  
  
  todayGirls.forEach(girl=>{  
    drinksList.forEach(d=>{  
      totals[d]+=girl.drinks[d];  
    });  
  });  
  
  csv += ["合計",...drinksList.map(d=>totals[d])].join(",")+"\n";  
  
  const bom=new Uint8Array([0xEF,0xBB,0xBF]);  
  const blob=new Blob([bom,csv],{type:"text/csv"});  
  const url=URL.createObjectURL(blob);  
  const a=document.createElement("a");  
  a.href=url;  
  a.download=`${date}.csv`;  
  a.click();  
  URL.revokeObjectURL(url);  
}  
  
// =================  
// リセット（ログ残す）  
// =================  
function resetToday(){  
  if(!confirm("数値だけリセットしますか？")) return;  
  todayGirls=[];  
  saveSession();  
  renderTable();  
  document.querySelectorAll("#girlList input")  
    .forEach(cb=>cb.checked=false);  
}  
</script>  
  
</body>  
</html>  
